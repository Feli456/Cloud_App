# .github/workflows/cics.yaml
name: Simulare CI-CD laborator

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  simulate-ci-cd:
    name: RuleazÄƒ linters + simulare deploy
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
    # 1. Checkout
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. InstaleazÄƒ yamllint pentru validarea fiÈ™ierelor K8s
    - name: Install yamllint
      run: |
        sudo apt-get update -y
        sudo apt-get install -y yamllint

    # 3. Validare manifest-uri Kubernetes
    - name: Validate Kubernetes YAML
      run: |
        echo "ğŸ” ValidÄƒm fiÈ™ierele din k8s/"
        yamllint k8s/

    # 4. Lint pentru PHP (opÈ›ional, ruleazÄƒ doar dacÄƒ gÄƒseÈ™te fiÈ™iere .php)
    - name: PHP syntax check
      if: ${{ hashFiles('php/**/*.php') != '' }}
      run: |
        echo "ğŸ” VerificÄƒm sintaxa PHP"
        find php -type f -name '*.php' -print0 | xargs -0 -I{} php -l {}

    # 5. Build local al imaginii Docker (opÈ›ional)
    - name: Build local Docker image "inter_cloud-web"
      if: ${{ hashFiles('**/Dockerfile') != '' }}
      run: |
        echo "ğŸ³ Construim imaginea localÄƒ inter_cloud-web (nu o publicÄƒm)"
        docker build -t inter_cloud-web .

    # 6. â€œDeployâ€ (simulat) â€“ doar afiÈ™Äƒm comenzile kubectl
    - name: Simulate Kubernetes deploy
      run: |
        echo "::group::SimulÄƒm kubectl apply"
        echo "kubectl apply -f k8s/mysql-initdb-config.yaml"
        echo "kubectl apply -f k8s/mysql-deployment.yaml"
        echo "kubectl apply -f k8s/mysql-service.yaml"
        echo "kubectl apply -f k8s/web-deployment.yaml"
        echo "kubectl apply -f k8s/web-service.yaml"
        echo "::endgroup::"
        echo "âœ… Deployment simulat cu succes!"
